{% extends 'base.html' %}

{% block title %}Video Call - InstaClone{% endblock %}

{% block content %}
<h3>Start a Video Call</h3>
<video id="localVideo" autoplay muted playsinline style="width: 45%; border: 2px solid #ccc;"></video>
<video id="remoteVideo" autoplay playsinline style="width: 45%; border: 2px solid #ccc;"></video>

<div class="mt-3">
  <button class="btn btn-success" onclick="startCall()">Start Call</button>
  <button class="btn btn-danger" onclick="endCall()">End Call</button>
</div>

<!-- ðŸ”Š Ringtone -->
<audio id="ringtone" src="{{ url_for('static', filename='ringtone.mp3') }}"></audio>

<script>
  const socket = io();
  let localStream;
  let peerConnection;

  const localVideo = document.getElementById('localVideo');
  const remoteVideo = document.getElementById('remoteVideo');
  const ringtone = document.getElementById('ringtone');

  const servers = {
    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
  };

  async function startCall() {
    // ðŸ”Š Play ringtone
    ringtone.play();

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];

      // ðŸ”‡ Stop ringtone when remote stream connects
      ringtone.pause();
      ringtone.currentTime = 0;
    };

    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        socket.emit('ice-candidate', e.candidate);
      }
    };

    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    socket.emit('video-offer', offer);
  }

  function endCall() {
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }

    if (localStream) {
      localStream.getTracks().forEach(track => track.stop());
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
    }

    // ðŸ”‡ Stop ringtone if still playing
    ringtone.pause();
    ringtone.currentTime = 0;

    socket.emit('end-call');
  }

  socket.on('video-offer', async offer => {
    ringtone.play(); // ðŸ”Š Ringtone for incoming offer

    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);
    localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

    peerConnection.ontrack = e => {
      remoteVideo.srcObject = e.streams[0];
      ringtone.pause();
      ringtone.currentTime = 0;
    };

    peerConnection.onicecandidate = e => {
      if (e.candidate) {
        socket.emit('ice-candidate', e.candidate);
      }
    };

    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    socket.emit('video-answer', answer);
  });

  socket.on('video-answer', answer => {
    peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
  });

  socket.on('ice-candidate', candidate => {
    peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
  });

  socket.on('end-call', () => {
    endCall();
  });
</script>
{% endblock %}
